<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidsparkè¦–é »ä¸Šå‚³å°ˆé …èª¿è©¦å·¥å…·</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f7fa; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        }
        .step { 
            margin: 20px 0; 
            padding: 20px; 
            border-left: 4px solid #3498db; 
            background: #f8f9fa; 
            border-radius: 5px; 
        }
        .success { color: #27ae60; background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #e74c3c; background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: #f39c12; background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #3498db; background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .btn { 
            background: #3498db; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-size: 14px;
        }
        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        textarea { 
            width: 100%; 
            height: 200px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .file-input { 
            margin: 10px 0; 
            padding: 10px; 
            border: 2px dashed #3498db; 
            border-radius: 5px; 
            text-align: center; 
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #e0e0e0; 
            border-radius: 10px; 
        }
        .log-entry { 
            font-family: monospace; 
            font-size: 11px; 
            padding: 5px; 
            margin: 2px 0; 
            background: #f1f2f6; 
            border-left: 3px solid #74b9ff; 
        }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: #ecf0f1; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        .progress-bar { 
            height: 100%; 
            background: #3498db; 
            width: 0%; 
            transition: width 0.3s; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Vidsparkè¦–é »ä¸Šå‚³å°ˆé …èª¿è©¦å·¥å…·</h1>
        <p><strong>ç›®çš„</strong>ï¼šç³»çµ±æ€§æ’æŸ¥è¦–é »ä¸Šå‚³500éŒ¯èª¤å’ŒJSONè§£æå•é¡Œ</p>
        <p><strong>ç‰ˆæœ¬</strong>ï¼šv1.0 | <strong>æ™‚é–“</strong>ï¼š<span id="current-time"></span></p>
        <hr>

        <!-- æ­¥é©Ÿ1ï¼šç’°å¢ƒæª¢æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ1ï¼šç’°å¢ƒç‹€æ…‹æª¢æŸ¥</h3>
            <button class="btn" onclick="checkEnvironment()">ğŸ” æª¢æŸ¥ç’°å¢ƒç‹€æ…‹</button>
            <div id="env-results"></div>
        </div>

        <!-- æ­¥é©Ÿ2ï¼šæ•¸æ“šåº«é€£æ¥æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ2ï¼šæ•¸æ“šåº«é€£æ¥æ·±åº¦æ¸¬è©¦</h3>
            <button class="btn" onclick="testDatabaseDeep()">ğŸ—„ï¸ æ·±åº¦æ•¸æ“šåº«æ¸¬è©¦</button>
            <div id="db-results"></div>
        </div>

        <!-- æ­¥é©Ÿ3ï¼šå°æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ3ï¼šå°æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦</h3>
            <div class="file-input">
                <input type="file" id="small-file" accept="video/*" />
                <p>è«‹é¸æ“‡ä¸€å€‹å°æ–¼5MBçš„æ¸¬è©¦è¦–é »æ–‡ä»¶</p>
            </div>
            <button class="btn" onclick="testSmallFileUpload()">ğŸ“¤ æ¸¬è©¦å°æ–‡ä»¶ä¸Šå‚³</button>
            <div id="small-file-results"></div>
        </div>

        <!-- æ­¥é©Ÿ4ï¼šè¡¨å–®æ•¸æ“šæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ4ï¼šè¡¨å–®æ•¸æ“šçµæ§‹æ¸¬è©¦</h3>
            <button class="btn" onclick="testFormDataStructure()">ğŸ“ æ¸¬è©¦è¡¨å–®æ•¸æ“š</button>
            <div id="form-data-results"></div>
        </div>

        <!-- æ­¥é©Ÿ5ï¼šAPIç«¯é»è©³ç´°æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ5ï¼šAPIç«¯é»è©³ç´°æ¸¬è©¦</h3>
            <button class="btn" onclick="testApiEndpoint()">ğŸ”— æ¸¬è©¦APIç«¯é»</button>
            <div id="api-results"></div>
        </div>

        <!-- æ­¥é©Ÿ6ï¼šéŒ¯èª¤é‡ç¾æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¥é©Ÿ6ï¼šéŒ¯èª¤é‡ç¾æ¸¬è©¦</h3>
            <div class="file-input">
                <input type="file" id="error-file" accept="video/*" />
                <p>é¸æ“‡ä»»æ„è¦–é »æ–‡ä»¶é‡ç¾éŒ¯èª¤</p>
            </div>
            <button class="btn" onclick="reproduceError()">ğŸ› é‡ç¾éŒ¯èª¤</button>
            <div id="error-results"></div>
        </div>

        <!-- å¯¦æ™‚æ—¥èªŒ -->
        <div class="test-section">
            <h3>ğŸ“‹ å¯¦æ™‚è¨ºæ–·æ—¥èªŒ</h3>
            <div id="debug-logs" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
            <button class="btn" onclick="clearLogs()">ğŸ§¹ æ¸…ç©ºæ—¥èªŒ</button>
            <button class="btn" onclick="exportLogs()">ğŸ’¾ å°å‡ºæ—¥èªŒ</button>
        </div>

        <!-- è§£æ±ºæ–¹æ¡ˆå»ºè­° -->
        <div class="test-section">
            <h3>ğŸ“‹ æ™ºèƒ½è§£æ±ºæ–¹æ¡ˆå»ºè­°</h3>
            <div id="solution-suggestions"></div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let debugLogs = [];
        let testResults = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            addLog('ğŸš€ Vidsparkè¦–é »ä¸Šå‚³èª¿è©¦å·¥å…·å·²å•Ÿå‹•', 'info');
        });

        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString('zh-TW');
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            debugLogs.push(logEntry);
            
            const logDiv = document.createElement('div');
            logDiv.className = 'log-entry';
            logDiv.innerHTML = `[${timestamp}] ${message}`;
            
            const logsContainer = document.getElementById('debug-logs');
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // æ­¥é©Ÿ1ï¼šç’°å¢ƒæª¢æŸ¥
        async function checkEnvironment() {
            addLog('ğŸ” é–‹å§‹ç’°å¢ƒç‹€æ…‹æª¢æŸ¥...', 'info');
            const resultsDiv = document.getElementById('env-results');
            
            try {
                // æª¢æŸ¥è¨ºæ–·ç«¯é»
                const response = await fetch('/vidspark-upload/video-diagnosis');
                const data = await response.json();
                
                let html = '<div class="success">âœ… ç’°å¢ƒè¨ºæ–·ç«¯é»æ­£å¸¸</div>';
                html += '<div class="info">ğŸ”§ PHPé…ç½®ä¿¡æ¯ï¼š</div>';
                html += `<ul>
                    <li>PHPç‰ˆæœ¬: ${data.diagnostics.php_version}</li>
                    <li>ä¸Šå‚³é™åˆ¶: ${data.diagnostics.upload_max_filesize}</li>
                    <li>POSTé™åˆ¶: ${data.diagnostics.post_max_size}</li>
                    <li>å…§å­˜é™åˆ¶: ${data.diagnostics.memory_limit}</li>
                    <li>æ•¸æ“šåº«é€£æ¥: ${data.diagnostics.database_connection}</li>
                </ul>`;
                
                // è™•ç†å­˜å„²ç›®éŒ„ä¿¡æ¯ï¼ˆæ”¯æŒæ–°æ ¼å¼å’ŒèˆŠæ ¼å¼ï¼‰
                html += '<div class="info">ğŸ“ å­˜å„²ç›®éŒ„ç‹€æ…‹ï¼š</div><ul>';
                if (data.diagnostics.storage_directory.video) {
                    // æ–°æ ¼å¼ï¼šåˆ†åˆ¥é¡¯ç¤ºvideo, audio, images
                    html += `<li>è¦–é »ç›®éŒ„: ${data.diagnostics.storage_directory.video.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'} (${data.diagnostics.storage_directory.video.writable ? 'å¯å¯«' : 'ä¸å¯å¯«'})</li>`;
                    html += `<li>éŸ³é »ç›®éŒ„: ${data.diagnostics.storage_directory.audio.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'} (${data.diagnostics.storage_directory.audio.writable ? 'å¯å¯«' : 'ä¸å¯å¯«'})</li>`;
                    html += `<li>åœ–ç‰‡ç›®éŒ„: ${data.diagnostics.storage_directory.images.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'} (${data.diagnostics.storage_directory.images.writable ? 'å¯å¯«' : 'ä¸å¯å¯«'})</li>`;
                } else {
                    // èˆŠæ ¼å¼ï¼šå–®ä¸€å­˜å„²ç›®éŒ„
                    html += `<li>å­˜å„²ç›®éŒ„: ${data.diagnostics.storage_directory.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>`;
                }
                html += '</ul>';
                
                resultsDiv.innerHTML = html;
                testResults.environment = data;
                addLog('âœ… ç’°å¢ƒæª¢æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ ç’°å¢ƒæª¢æŸ¥å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ ç’°å¢ƒæª¢æŸ¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ­¥é©Ÿ2ï¼šæ•¸æ“šåº«æ·±åº¦æ¸¬è©¦
        async function testDatabaseDeep() {
            addLog('ğŸ—„ï¸ é–‹å§‹æ•¸æ“šåº«æ·±åº¦æ¸¬è©¦...', 'info');
            const resultsDiv = document.getElementById('db-results');
            
            try {
                const response = await fetch('/vidspark-quick-db-init');
                const data = await response.json();
                
                let html = `<div class="${data.success ? 'success' : 'error'}">
                    ${data.success ? 'âœ…' : 'âŒ'} æ•¸æ“šåº«æ¸¬è©¦: ${data.message}
                </div>`;
                
                html += '<div class="info">ğŸ“Š è©³ç´°çµæœï¼š</div><ul>';
                data.results.forEach(result => {
                    html += `<li>${result}</li>`;
                });
                html += '</ul>';
                
                resultsDiv.innerHTML = html;
                testResults.database = data;
                addLog(`âœ… æ•¸æ“šåº«æ¸¬è©¦å®Œæˆ: ${data.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`, data.success ? 'success' : 'error');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ æ•¸æ“šåº«æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ æ•¸æ“šåº«æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ­¥é©Ÿ3ï¼šå°æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦
        async function testSmallFileUpload() {
            const fileInput = document.getElementById('small-file');
            const resultsDiv = document.getElementById('small-file-results');
            
            if (!fileInput.files[0]) {
                resultsDiv.innerHTML = '<div class="warning">âš ï¸ è«‹å…ˆé¸æ“‡ä¸€å€‹æ¸¬è©¦æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const fileSizeKB = file.size / 1024;
            const fileSizeMB = fileSizeKB / 1024;
            
            // æª¢æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
            if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                resultsDiv.innerHTML = '<div class="error">âŒ æ–‡ä»¶å¤ªå¤§ï¼è«‹é¸æ“‡å°æ–¼5MBçš„è¦–é »æ–‡ä»¶</div>';
                return;
            }
            
            addLog(`ğŸ“¤ é–‹å§‹å°æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦: ${file.name} (${fileSizeMB.toFixed(2)}MB)`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('video', file);
                
                addLog('ğŸ“¨ æ­£åœ¨ç™¼é€è«‹æ±‚åˆ° /vidspark-upload/video...', 'info');
                
                const response = await fetch('/vidspark-upload/video', {
                    method: 'POST',
                    body: formData
                });
                
                addLog(`ğŸ“¥ æœå‹™å™¨éŸ¿æ‡‰: ${response.status} ${response.statusText}`, 'info');
                
                const responseText = await response.text();
                addLog(`ğŸ“„ éŸ¿æ‡‰å…§å®¹é¡å‹: ${response.headers.get('content-type')}`, 'info');
                addLog(`ğŸ“„ éŸ¿æ‡‰å…§å®¹é•·åº¦: ${responseText.length} å­—ç¬¦`, 'info');
                
                let html = `<div class="info">ğŸ” éŸ¿æ‡‰åˆ†æï¼š</div>`;
                html += `<p><strong>ç‹€æ…‹ç¢¼</strong>: ${response.status} ${response.statusText}</p>`;
                html += `<p><strong>å…§å®¹é¡å‹</strong>: ${response.headers.get('content-type')}</p>`;
                html += `<p><strong>éŸ¿æ‡‰é•·åº¦</strong>: ${responseText.length} å­—ç¬¦</p>`;
                
                // å˜—è©¦è§£æJSON
                try {
                    const jsonData = JSON.parse(responseText);
                    html += `<div class="success">âœ… JSONè§£ææˆåŠŸ</div>`;
                    html += `<pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">${JSON.stringify(jsonData, null, 2)}</pre>`;
                    addLog('âœ… å°æ–‡ä»¶ä¸Šå‚³æ¸¬è©¦æˆåŠŸï¼', 'success');
                } catch (jsonError) {
                    html += `<div class="error">âŒ JSONè§£æå¤±æ•—: ${jsonError.message}</div>`;
                    html += `<div class="warning">âš ï¸ åŸå§‹éŸ¿æ‡‰å…§å®¹ï¼ˆå‰500å­—ç¬¦ï¼‰ï¼š</div>`;
                    html += `<textarea readonly>${responseText.substring(0, 500)}</textarea>`;
                    addLog(`âŒ JSONè§£æéŒ¯èª¤: ${jsonError.message}`, 'error');
                }
                
                resultsDiv.innerHTML = html;
                testResults.smallFile = { response: responseText, status: response.status };
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ ä¸Šå‚³è«‹æ±‚å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ ä¸Šå‚³è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ­¥é©Ÿ4ï¼šè¡¨å–®æ•¸æ“šçµæ§‹æ¸¬è©¦
        async function testFormDataStructure() {
            addLog('ğŸ“ é–‹å§‹è¡¨å–®æ•¸æ“šçµæ§‹æ¸¬è©¦...', 'info');
            const resultsDiv = document.getElementById('form-data-results');
            
            try {
                // å‰µå»ºæ¸¬è©¦ç”¨çš„Blobæ–‡ä»¶
                const testBlob = new Blob(['test video content'], { type: 'video/mp4' });
                const testFile = new File([testBlob], 'test.mp4', { type: 'video/mp4' });
                
                const formData = new FormData();
                formData.append('video', testFile);
                
                addLog('ğŸ“Š æ¸¬è©¦FormDataçµæ§‹...', 'info');
                
                // é¡¯ç¤ºFormDataå…§å®¹
                let html = '<div class="info">ğŸ“‹ FormDataçµæ§‹åˆ†æï¼š</div>';
                html += '<ul>';
                for (let [key, value] of formData.entries()) {
                    if (value instanceof File) {
                        html += `<li><strong>${key}</strong>: File(name="${value.name}", size=${value.size}, type="${value.type}")</li>`;
                    } else {
                        html += `<li><strong>${key}</strong>: ${value}</li>`;
                    }
                }
                html += '</ul>';
                
                // æ¸¬è©¦fetchè«‹æ±‚é…ç½®
                const requestConfig = {
                    method: 'POST',
                    body: formData,
                    // ä¸è¨­ç½®Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®
                };
                
                html += '<div class="info">ğŸ”§ è«‹æ±‚é…ç½®ï¼š</div>';
                html += `<pre style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${JSON.stringify({
                    method: requestConfig.method,
                    bodyType: 'FormData',
                    fileCount: 1
                }, null, 2)}</pre>`;
                
                resultsDiv.innerHTML = html;
                addLog('âœ… è¡¨å–®æ•¸æ“šçµæ§‹æ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ è¡¨å–®æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ è¡¨å–®æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ­¥é©Ÿ5ï¼šAPIç«¯é»æ¸¬è©¦
        async function testApiEndpoint() {
            addLog('ğŸ”— é–‹å§‹APIç«¯é»è©³ç´°æ¸¬è©¦...', 'info');
            const resultsDiv = document.getElementById('api-results');
            
            try {
                // æ¸¬è©¦ä¸åŒçš„HTTPæ–¹æ³•
                const tests = [
                    { method: 'GET', description: 'æ¸¬è©¦GETè«‹æ±‚ï¼ˆæ‡‰è©²å¤±æ•—ï¼‰' },
                    { method: 'POST', description: 'æ¸¬è©¦ç©ºPOSTè«‹æ±‚' },
                    { method: 'POST', description: 'æ¸¬è©¦ç„¡æ•ˆæ•¸æ“šPOST', body: 'invalid data' }
                ];
                
                let html = '<div class="info">ğŸ”§ APIç«¯é»æ¸¬è©¦çµæœï¼š</div>';
                
                for (const test of tests) {
                    addLog(`ğŸ” ${test.description}...`, 'info');
                    
                    try {
                        const response = await fetch('/vidspark-upload/video', {
                            method: test.method,
                            body: test.body
                        });
                        
                        const responseText = await response.text();
                        const contentType = response.headers.get('content-type');
                        
                        html += `<div class="step">
                            <h4>${test.description}</h4>
                            <p><strong>ç‹€æ…‹</strong>: ${response.status} ${response.statusText}</p>
                            <p><strong>å…§å®¹é¡å‹</strong>: ${contentType}</p>
                            <p><strong>éŸ¿æ‡‰é•·åº¦</strong>: ${responseText.length}</p>
                        `;
                        
                        if (contentType && contentType.includes('application/json')) {
                            try {
                                const jsonData = JSON.parse(responseText);
                                html += `<div class="success">âœ… JSONæ ¼å¼æ­£ç¢º</div>`;
                                html += `<pre style="font-size: 11px;">${JSON.stringify(jsonData, null, 2)}</pre>`;
                            } catch (e) {
                                html += `<div class="error">âŒ JSONè§£æå¤±æ•—</div>`;
                            }
                        } else {
                            html += `<div class="warning">âš ï¸ éJSONéŸ¿æ‡‰</div>`;
                            html += `<textarea readonly style="height: 80px;">${responseText.substring(0, 200)}</textarea>`;
                        }
                        
                        html += '</div>';
                        
                    } catch (error) {
                        html += `<div class="error">âŒ ${test.description} å¤±æ•—: ${error.message}</div>`;
                    }
                }
                
                resultsDiv.innerHTML = html;
                addLog('âœ… APIç«¯é»æ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ APIæ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ APIæ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // æ­¥é©Ÿ6ï¼šéŒ¯èª¤é‡ç¾
        async function reproduceError() {
            const fileInput = document.getElementById('error-file');
            const resultsDiv = document.getElementById('error-results');
            
            if (!fileInput.files[0]) {
                resultsDiv.innerHTML = '<div class="warning">âš ï¸ è«‹å…ˆé¸æ“‡ä¸€å€‹è¦–é »æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            addLog(`ğŸ› é–‹å§‹éŒ¯èª¤é‡ç¾æ¸¬è©¦: ${file.name}`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('video', file);
                
                addLog('ğŸ“¨ ç™¼é€è«‹æ±‚ä»¥é‡ç¾éŒ¯èª¤...', 'info');
                
                const startTime = Date.now();
                const response = await fetch('/vidspark-upload/video', {
                    method: 'POST',
                    body: formData
                });
                const endTime = Date.now();
                
                const responseText = await response.text();
                const contentType = response.headers.get('content-type');
                
                let html = `<div class="info">ğŸ” éŒ¯èª¤é‡ç¾çµæœï¼š</div>`;
                html += `<p><strong>æ–‡ä»¶</strong>: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)</p>`;
                html += `<p><strong>éŸ¿æ‡‰æ™‚é–“</strong>: ${endTime - startTime}ms</p>`;
                html += `<p><strong>ç‹€æ…‹ç¢¼</strong>: ${response.status} ${response.statusText}</p>`;
                html += `<p><strong>å…§å®¹é¡å‹</strong>: ${contentType}</p>`;
                
                if (response.status === 500) {
                    html += `<div class="error">âŒ ç¢ºèª500éŒ¯èª¤é‡ç¾</div>`;
                    addLog('ğŸ¯ æˆåŠŸé‡ç¾500éŒ¯èª¤ï¼', 'error');
                    
                    // åˆ†æéŒ¯èª¤å…§å®¹
                    if (responseText.includes('ErrorException') || responseText.includes('Fatal error')) {
                        html += `<div class="warning">âš ï¸ æª¢æ¸¬åˆ°PHPéŒ¯èª¤é é¢</div>`;
                        addLog('ğŸ” æª¢æ¸¬åˆ°PHP Fatal Erroræˆ–Exception', 'error');
                    }
                    
                    if (responseText.includes('Unexpected token')) {
                        html += `<div class="warning">âš ï¸ å‰ç«¯å˜—è©¦è§£æHTMLç‚ºJSONå°è‡´éŒ¯èª¤</div>`;
                        addLog('ğŸ” å‰ç«¯JSONè§£æéŒ¯èª¤ï¼ˆè©¦åœ–è§£æHTMLï¼‰', 'error');
                    }
                    
                    html += `<div class="warning">ğŸ“„ éŒ¯èª¤éŸ¿æ‡‰å…§å®¹ï¼ˆå‰1000å­—ç¬¦ï¼‰ï¼š</div>`;
                    html += `<textarea readonly style="height: 150px;">${responseText.substring(0, 1000)}</textarea>`;
                }
                
                resultsDiv.innerHTML = html;
                testResults.errorReproduction = { 
                    status: response.status, 
                    contentType: contentType, 
                    responseText: responseText.substring(0, 1000) 
                };
                
                // ç”Ÿæˆè§£æ±ºæ–¹æ¡ˆå»ºè­°
                generateSolutions();
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ éŒ¯èª¤é‡ç¾å¤±æ•—: ${error.message}</div>`;
                addLog(`âŒ éŒ¯èª¤é‡ç¾å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆè§£æ±ºæ–¹æ¡ˆå»ºè­°
        function generateSolutions() {
            addLog('ğŸ’¡ ç”Ÿæˆæ™ºèƒ½è§£æ±ºæ–¹æ¡ˆå»ºè­°...', 'info');
            const suggestionsDiv = document.getElementById('solution-suggestions');
            
            let solutions = [];
            
            // åŸºæ–¼æ¸¬è©¦çµæœåˆ†æå•é¡Œ
            if (testResults.errorReproduction && testResults.errorReproduction.status === 500) {
                solutions.push({
                    priority: 'high',
                    title: '500éŒ¯èª¤åˆ†æ',
                    description: 'PHPæœå‹™å™¨ç«¯ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤ï¼Œè¿”å›HTMLéŒ¯èª¤é é¢è€ŒéJSON',
                    actions: [
                        'æª¢æŸ¥PHPéŒ¯èª¤æ—¥èªŒ',
                        'ç¢ºèªVidsparkFileUploadController.phpèªæ³•æ­£ç¢ºæ€§',
                        'é©—è­‰think\\facade\\Dbé¡å°å…¥æ˜¯å¦æ­£ç¢º',
                        'æª¢æŸ¥æ•¸æ“šåº«é€£æ¥é…ç½®'
                    ]
                });
            }
            
            if (testResults.environment && testResults.environment.diagnostics.upload_max_filesize === '2M') {
                solutions.push({
                    priority: 'medium',
                    title: 'PHPä¸Šå‚³é™åˆ¶éå°',
                    description: 'ç•¶å‰ä¸Šå‚³é™åˆ¶åƒ…2MBï¼Œå¯èƒ½å°è‡´å¤§æ–‡ä»¶ä¸Šå‚³å¤±æ•—',
                    actions: [
                        'è€ƒæ…®ä½¿ç”¨Base64ç·¨ç¢¼ä¸Šå‚³ç¹éPHPé™åˆ¶',
                        'åœ¨Zeaburä¸­è¨­ç½®ç’°å¢ƒè®Šé‡å¢åŠ PHPé™åˆ¶',
                        'ä½¿ç”¨åˆ†ç‰‡ä¸Šå‚³æ©Ÿåˆ¶'
                    ]
                });
            }
            
            if (testResults.database && !testResults.database.success) {
                solutions.push({
                    priority: 'high',
                    title: 'æ•¸æ“šåº«å•é¡Œ',
                    description: 'æ•¸æ“šåº«æ“ä½œå¤±æ•—å¯èƒ½å°è‡´æ•´å€‹ä¸Šå‚³æµç¨‹ä¸­æ–·',
                    actions: [
                        'é‡æ–°é‹è¡Œæ•¸æ“šåº«åˆå§‹åŒ–è…³æœ¬',
                        'æª¢æŸ¥æ•¸æ“šåº«é€£æ¥é…ç½®',
                        'é©—è­‰è¡¨çµæ§‹æ˜¯å¦æ­£ç¢º'
                    ]
                });
            }
            
            // é€šç”¨è§£æ±ºæ–¹æ¡ˆ
            solutions.push({
                priority: 'medium',
                title: 'é€šç”¨è§£æ±ºæ–¹æ¡ˆ',
                description: 'åŸºæ–¼å¸¸è¦‹å•é¡Œçš„è§£æ±ºæ–¹æ¡ˆ',
                actions: [
                    'é‡æ–°éƒ¨ç½²æ‡‰ç”¨ç¢ºä¿ä»£ç¢¼æœ€æ–°',
                    'æª¢æŸ¥Zeaburæ—¥èªŒç²å–è©³ç´°éŒ¯èª¤ä¿¡æ¯',
                    'ä½¿ç”¨æ›´å°çš„æ¸¬è©¦æ–‡ä»¶é©—è­‰åŸºæœ¬åŠŸèƒ½',
                    'è¯ç¹«æŠ€è¡“æ”¯æŒæä¾›å®Œæ•´éŒ¯èª¤æ—¥èªŒ'
                ]
            });
            
            let html = '<div class="info">ğŸ’¡ åŸºæ–¼è¨ºæ–·çµæœçš„æ™ºèƒ½å»ºè­°ï¼š</div>';
            
            solutions.forEach((solution, index) => {
                const priorityClass = solution.priority === 'high' ? 'error' : solution.priority === 'medium' ? 'warning' : 'info';
                html += `<div class="${priorityClass}" style="margin: 15px 0;">
                    <h4>ğŸ¯ ${solution.title} (${solution.priority} å„ªå…ˆç´š)</h4>
                    <p>${solution.description}</p>
                    <ul>`;
                solution.actions.forEach(action => {
                    html += `<li>${action}</li>`;
                });
                html += '</ul></div>';
            });
            
            suggestionsDiv.innerHTML = html;
            addLog('âœ… è§£æ±ºæ–¹æ¡ˆå»ºè­°ç”Ÿæˆå®Œæˆ', 'success');
        }

        // å·¥å…·å‡½æ•¸
        function clearLogs() {
            debugLogs = [];
            document.getElementById('debug-logs').innerHTML = '';
            addLog('ğŸ§¹ æ—¥èªŒå·²æ¸…ç©º', 'info');
        }

        function exportLogs() {
            const logText = debugLogs.map(log => `[${log.time}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vidspark-debug-logs-${new Date().toISOString().substr(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('ğŸ’¾ æ—¥èªŒå·²å°å‡º', 'success');
        }
    </script>
</body>
</html>
