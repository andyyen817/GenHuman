<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidsparkè·¯å¾‘èª¿è©¦å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .success { color: #27ae60; background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #e74c3c; background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #3498db; background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .btn { background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        .btn:hover { background: #2980b9; }
        .path-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .path-table th, .path-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-family: monospace; font-size: 12px; }
        .path-table th { background: #f2f2f2; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Vidsparkè·¯å¾‘èª¿è©¦å·¥å…·</h1>
        <p><strong>ç›®çš„</strong>ï¼šè¨ºæ–·å­˜å„²ç›®éŒ„è·¯å¾‘ä¸åŒ¹é…å•é¡Œ</p>
        <p><strong>æ™‚é–“</strong>ï¼š<span id="current-time"></span></p>
        <hr>

        <div class="debug-section">
            <h3>ğŸ“… æ—¥æœŸè¨ˆç®—èª¿è©¦</h3>
            <button class="btn" onclick="debugDatePaths()">ğŸ” æª¢æŸ¥æ—¥æœŸè·¯å¾‘</button>
            <div id="date-debug-results"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ“ ç›®éŒ„çµæ§‹æƒæ</h3>
            <button class="btn" onclick="scanDirectories()">ğŸ“‚ æƒæå­˜å„²ç›®éŒ„</button>
            <div id="directory-scan-results"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”„ è·¯å¾‘ä¸€è‡´æ€§æ¸¬è©¦</h3>
            <button class="btn" onclick="testPathConsistency()">âš–ï¸ æ¸¬è©¦è·¯å¾‘ä¸€è‡´æ€§</button>
            <div id="consistency-results"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ› ï¸ ä¿®å¾©å»ºè­°</h3>
            <div id="fix-suggestions"></div>
        </div>
    </div>

    <script>
        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString('zh-TW');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        // èª¿è©¦æ—¥æœŸè·¯å¾‘
        async function debugDatePaths() {
            const resultsDiv = document.getElementById('date-debug-results');
            
            try {
                const now = new Date();
                const timezoneOffset = now.getTimezoneOffset();
                
                let html = '<div class="info">ğŸ“… ç•¶å‰æ™‚é–“ä¿¡æ¯ï¼š</div>';
                html += '<table class="path-table">';
                html += '<tr><th>æ™‚é–“é¡å‹</th><th>å€¼</th><th>ç”¨æ–¼è·¯å¾‘</th></tr>';
                html += `<tr><td>æœ¬åœ°æ™‚é–“</td><td>${now.toLocaleString('zh-TW')}</td><td>${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}</td></tr>`;
                html += `<tr><td>UTCæ™‚é–“</td><td>${now.toISOString()}</td><td>${now.getUTCFullYear()}/${(now.getUTCMonth()+1).toString().padStart(2,'0')}</td></tr>`;
                html += `<tr><td>æ™‚å€åç§»</td><td>${timezoneOffset}åˆ†é˜</td><td>å½±éŸ¿æ—¥æœŸè¨ˆç®—</td></tr>`;
                html += '</table>';

                // æ¸¬è©¦PHPç«¯çš„æ—¥æœŸè¨ˆç®—
                const response = await fetch('/vidspark-upload/video-diagnosis');
                const data = await response.json();
                
                html += '<div class="info">ğŸ” PHPç«¯è·¯å¾‘åˆ†æï¼š</div>';
                html += '<table class="path-table">';
                html += '<tr><th>ç›®éŒ„é¡å‹</th><th>å®Œæ•´è·¯å¾‘</th><th>å­˜åœ¨ç‹€æ…‹</th><th>å¹´/æœˆ</th></tr>';
                
                if (data.diagnostics.storage_directory.video) {
                    const videoPath = data.diagnostics.storage_directory.video.path;
                    const audioPath = data.diagnostics.storage_directory.audio.path;
                    const imagesPath = data.diagnostics.storage_directory.images.path;
                    
                    // å¾è·¯å¾‘ä¸­æå–å¹´æœˆ
                    const extractYearMonth = (path) => {
                        const match = path.match(/(\d{4})\/(\d{2})/);
                        return match ? `${match[1]}/${match[2]}` : 'æœªæ‰¾åˆ°';
                    };
                    
                    html += `<tr><td>è¦–é »ç›®éŒ„</td><td>${videoPath}</td><td>${data.diagnostics.storage_directory.video.exists ? 'âœ…' : 'âŒ'}</td><td>${extractYearMonth(videoPath)}</td></tr>`;
                    html += `<tr><td>éŸ³é »ç›®éŒ„</td><td>${audioPath}</td><td>${data.diagnostics.storage_directory.audio.exists ? 'âœ…' : 'âŒ'}</td><td>${extractYearMonth(audioPath)}</td></tr>`;
                    html += `<tr><td>åœ–ç‰‡ç›®éŒ„</td><td>${imagesPath}</td><td>${data.diagnostics.storage_directory.images.exists ? 'âœ…' : 'âŒ'}</td><td>${extractYearMonth(imagesPath)}</td></tr>`;
                } else {
                    html += '<tr><td colspan="4">èˆŠæ ¼å¼è¨ºæ–·æ•¸æ“š</td></tr>';
                }
                
                html += '</table>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ æ—¥æœŸè·¯å¾‘èª¿è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }

        // æƒæç›®éŒ„çµæ§‹
        async function scanDirectories() {
            const resultsDiv = document.getElementById('directory-scan-results');
            
            try {
                // å˜—è©¦é€šéæ•¸æ“šåº«åˆå§‹åŒ–æŸ¥çœ‹å‰µå»ºäº†å“ªäº›ç›®éŒ„
                const response = await fetch('/vidspark-quick-db-init');
                const data = await response.json();
                
                let html = '<div class="info">ğŸ“‚ æ•¸æ“šåº«åˆå§‹åŒ–å ±å‘Šçš„ç›®éŒ„ï¼š</div>';
                html += '<ul>';
                
                data.results.forEach(result => {
                    if (result.includes('å‰µå»ºç›®éŒ„:') || result.includes('ç›®éŒ„å·²å­˜åœ¨:')) {
                        const isSuccess = result.includes('âœ…');
                        const pathMatch = result.match(/\/var\/www\/html\/server\/public\/vidspark\/storage\/[^\\s]+/);
                        const path = pathMatch ? pathMatch[0] : 'æœªçŸ¥è·¯å¾‘';
                        
                        html += `<li class="${isSuccess ? 'success' : 'error'}">${result}</li>`;
                    }
                });
                
                html += '</ul>';
                
                // åˆ†æè·¯å¾‘æ¨¡å¼
                html += '<div class="info">ğŸ” è·¯å¾‘æ¨¡å¼åˆ†æï¼š</div>';
                const pathPattern = data.results.find(r => r.includes('/2025/08'));
                if (pathPattern) {
                    html += '<div class="success">âœ… ç¢ºèªä½¿ç”¨ 2025/08 è·¯å¾‘æ¨¡å¼</div>';
                } else {
                    html += '<div class="error">âŒ æœªæ‰¾åˆ°æ˜ç¢ºçš„è·¯å¾‘æ¨¡å¼</div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ ç›®éŒ„æƒæå¤±æ•—: ${error.message}</div>`;
            }
        }

        // æ¸¬è©¦è·¯å¾‘ä¸€è‡´æ€§
        async function testPathConsistency() {
            const resultsDiv = document.getElementById('consistency-results');
            
            try {
                // ä¸¦è¡Œèª¿ç”¨å…©å€‹ç«¯é»
                const [diagResponse, initResponse] = await Promise.all([
                    fetch('/vidspark-upload/video-diagnosis'),
                    fetch('/vidspark-quick-db-init')
                ]);
                
                const diagData = await diagResponse.json();
                const initData = await initResponse.json();
                
                let html = '<div class="info">âš–ï¸ è·¯å¾‘ä¸€è‡´æ€§å°æ¯”ï¼š</div>';
                html += '<table class="path-table">';
                html += '<tr><th>ä¾†æº</th><th>é¡å‹</th><th>è·¯å¾‘</th><th>ç‹€æ…‹</th></tr>';
                
                // è¨ºæ–·ç«¯é»è·¯å¾‘
                if (diagData.diagnostics.storage_directory.video) {
                    html += `<tr><td rowspan="3">è¨ºæ–·æª¢æŸ¥</td><td>è¦–é »</td><td>${diagData.diagnostics.storage_directory.video.path}</td><td>${diagData.diagnostics.storage_directory.video.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</td></tr>`;
                    html += `<tr><td>éŸ³é »</td><td>${diagData.diagnostics.storage_directory.audio.path}</td><td>${diagData.diagnostics.storage_directory.audio.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</td></tr>`;
                    html += `<tr><td>åœ–ç‰‡</td><td>${diagData.diagnostics.storage_directory.images.path}</td><td>${diagData.diagnostics.storage_directory.images.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</td></tr>`;
                }
                
                // åˆå§‹åŒ–è…³æœ¬è·¯å¾‘
                const createdPaths = initData.results.filter(r => r.includes('å‰µå»ºç›®éŒ„:') || r.includes('ç›®éŒ„å·²å­˜åœ¨:'));
                createdPaths.forEach((result, index) => {
                    const pathMatch = result.match(/\/var\/www\/html\/server\/public\/vidspark\/storage\/(\w+)\/[^\\s]+/);
                    if (pathMatch) {
                        const type = pathMatch[1];
                        const fullPath = result.match(/\/var\/www\/html\/server\/public\/vidspark\/storage\/[^\\s]+/)[0];
                        const isSuccess = result.includes('âœ…');
                        
                        html += `<tr><td ${index === 0 ? `rowspan="${createdPaths.length}"` : 'style="display:none"'}>æ•¸æ“šåº«åˆå§‹åŒ–</td><td>${type}</td><td>${fullPath}</td><td>${isSuccess ? 'âœ… å·²å‰µå»º' : 'âŒ å‰µå»ºå¤±æ•—'}</td></tr>`;
                    }
                });
                
                html += '</table>';
                
                // ä¸€è‡´æ€§åˆ†æ
                html += '<div class="info">ğŸ“Š ä¸€è‡´æ€§åˆ†æï¼š</div>';
                if (diagData.diagnostics.storage_directory.video) {
                    const diagVideoExists = diagData.diagnostics.storage_directory.video.exists;
                    const initHasVideo = initData.results.some(r => r.includes('video') && r.includes('âœ…'));
                    
                    if (initHasVideo && !diagVideoExists) {
                        html += '<div class="error">âŒ ç›®éŒ„å‰µå»ºæˆåŠŸä½†æª¢æŸ¥å¤±æ•— - å¯èƒ½æ˜¯è·¯å¾‘è¨ˆç®—ä¸ä¸€è‡´</div>';
                    } else if (diagVideoExists && initHasVideo) {
                        html += '<div class="success">âœ… è·¯å¾‘ä¸€è‡´æ€§è‰¯å¥½</div>';
                    } else {
                        html += '<div class="error">âŒ è·¯å¾‘å­˜åœ¨å•é¡Œ</div>';
                    }
                }
                
                resultsDiv.innerHTML = html;
                
                // ç”Ÿæˆä¿®å¾©å»ºè­°
                generateFixSuggestions(diagData, initData);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ ä¸€è‡´æ€§æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }

        // ç”Ÿæˆä¿®å¾©å»ºè­°
        function generateFixSuggestions(diagData, initData) {
            const suggestionsDiv = document.getElementById('fix-suggestions');
            
            let html = '<div class="info">ğŸ’¡ æ™ºèƒ½ä¿®å¾©å»ºè­°ï¼š</div>';
            
            const diagVideoExists = diagData.diagnostics.storage_directory?.video?.exists;
            const initHasVideo = initData.results.some(r => r.includes('video') && r.includes('âœ…'));
            
            if (initHasVideo && !diagVideoExists) {
                html += `
                <div class="error">
                    <h4>ğŸ¯ ä¸»è¦å•é¡Œï¼šè·¯å¾‘è¨ˆç®—ä¸ä¸€è‡´</h4>
                    <p><strong>ç—‡ç‹€</strong>ï¼šæ•¸æ“šåº«åˆå§‹åŒ–æˆåŠŸå‰µå»ºç›®éŒ„ï¼Œä½†è¨ºæ–·æª¢æŸ¥æ‰¾ä¸åˆ°</p>
                    <p><strong>å¯èƒ½åŸå› </strong>ï¼š</p>
                    <ul>
                        <li>æ™‚å€å·®ç•°å°è‡´date()å‡½æ•¸è¨ˆç®—ä¸åŒçš„å¹´æœˆ</li>
                        <li>æœå‹™å™¨æ™‚é–“èˆ‡æœ¬åœ°æ™‚é–“ä¸åŒæ­¥</li>
                        <li>ä¸åŒPHPå‡½æ•¸ä½¿ç”¨ä¸åŒçš„æ™‚é–“åŸºæº–</li>
                    </ul>
                    <p><strong>è§£æ±ºæ–¹æ¡ˆ</strong>ï¼š</p>
                    <ol>
                        <li>çµ±ä¸€æ‰€æœ‰ä»£ç¢¼ä½¿ç”¨ç›¸åŒçš„æ™‚é–“å‡½æ•¸å’Œæ™‚å€</li>
                        <li>ä½¿ç”¨å›ºå®šçš„æ—¥æœŸè·¯å¾‘è€Œéå‹•æ…‹è¨ˆç®—</li>
                        <li>æ·»åŠ ç›®éŒ„è‡ªå‹•å‰µå»ºé‚è¼¯åˆ°è¨ºæ–·ç«¯é»</li>
                        <li>ä½¿ç”¨è»Ÿéˆæ¥è§£æ±ºè·¯å¾‘å·®ç•°</li>
                    </ol>
                </div>`;
            }
            
            html += `
            <div class="info">
                <h4>ğŸ”§ ç«‹å³å¯åŸ·è¡Œçš„ä¿®å¾©æ­¥é©Ÿï¼š</h4>
                <ol>
                    <li><strong>çŸ­æœŸè§£æ±º</strong>ï¼šä¿®æ”¹è¨ºæ–·ç«¯é»ä½¿ç”¨èˆ‡åˆå§‹åŒ–ç›¸åŒçš„è·¯å¾‘é‚è¼¯</li>
                    <li><strong>ä¸­æœŸè§£æ±º</strong>ï¼šçµ±ä¸€å…¨é …ç›®çš„æ—¥æœŸè·¯å¾‘è¨ˆç®—æ–¹å¼</li>
                    <li><strong>é•·æœŸè§£æ±º</strong>ï¼šå¯¦ç¾æ™ºèƒ½ç›®éŒ„å‰µå»ºæ©Ÿåˆ¶</li>
                </ol>
            </div>`;
            
            suggestionsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
